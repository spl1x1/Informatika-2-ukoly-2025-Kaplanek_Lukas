name: Sync Fork with Upstream
#on:
  #schedule:
    #- cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Forked Repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          fetch-depth: 0
          ref: master

      - name: Configure Git
        run: |
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          git config --global user.name "${{ github.actor }}"

      - name: Add Upstream Remote
        run: git remote add upstream https://github.com/TomasRacil/Informatika-2-ukoly-2025.git

      - name: Fetch Upstream Changes
        run: git fetch upstream

      - name: Merge and Auto-resolve All Conflicts
        run: |
          # Attempt merge
          git merge upstream/master --allow-unrelated-histories -X ours --no-commit || true
          
          # Check if there are conflicts
          if git status | grep -q "Unmerged paths"; then
            echo "Resolving conflicts automatically..."
            
            # Handle modify/delete conflicts (deleted by us, modified by them)
            # We want to keep them deleted, so remove them
            git status --porcelain | grep '^DU' | cut -c4- | while read file; do
              echo "Removing file deleted in our branch: $file"
              git rm "$file"
            done
            
            # Handle add/add conflicts (file added in both branches)
            # Keep our version
            git status --porcelain | grep '^AA' | cut -c4- | while read file; do
              echo "Keeping our version of: $file"
              git checkout --ours "$file"
              git add "$file"
            done
            
            # Handle both modified conflicts
            git status --porcelain | grep '^UU' | cut -c4- | while read file; do
              echo "Keeping our version of: $file"
              git checkout --ours "$file"
              git add "$file"
            done
            
            # Handle any other unmerged files
            git status --porcelain | grep '^U' | cut -c4- | while read file; do
              echo "Resolving: $file"
              if git ls-files --stage "$file" | grep -q "^100.*:1:"; then
                # File exists in our branch, keep our version
                git checkout --ours "$file" 2>/dev/null && git add "$file" || git rm "$file"
              else
                # File doesn't exist in our branch, remove it
                git rm "$file" 2>/dev/null || true
              fi
            done
            
            git commit -m "Merge upstream/master into master (auto-resolved conflicts)"
          else
            git commit -m "Merge upstream/master into master" || echo "Nothing to commit"
          fi

      - name: Push Changes
        run: git push origin master
